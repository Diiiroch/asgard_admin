<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASGARD CRA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.css">
    <style>
        .fc-event {
            .fc-time {
                display: none;
            }
            
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-6">

            </div>
            <div class="col-md-6 text-end">
                <div class="pdf-button">
                    <button id="events-btn" class="btn btn-primary" >Valider les informations</button>
                </div>
            </div>
        </div>
        <div id="calendar"></div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@3.9.0/dist/locale-all.min.js"></script>
<script>
   $(document).ready(function () {
    $('#calendar').fullCalendar({
        locale: "fr",
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        selectable: true,
        selectHelper: true,
        editable: true,
        eventLimit: true,
        validRange: function (nowDate) {
            var startOfMonth = nowDate.clone().subtract(3, 'months').startOf('month');
            var endOfMonth = nowDate.clone().endOf('month');
            return {
                start: startOfMonth,
                end: endOfMonth
            };
        },
        select: function (start, end, allDay) {
            var selectedDates = [];
            var currentDate = start.clone();
            
            // Construire un tableau de dates pour les jours sélectionnés
            while (currentDate.isBefore(end)) {
                selectedDates.push(currentDate.format('YYYY-MM-DD'));
                currentDate.add(1, 'day');
            }

            // Vérifier si un événement existe déjà pour au moins une des dates sélectionnées
            var eventExists = false;
            selectedDates.forEach(function(date) {
                var eventsOnSelectedDate = $('#calendar').fullCalendar('clientEvents', function(event) {
                    return event.start.format('YYYY-MM-DD') === date;
                });

                if (eventsOnSelectedDate.length > 0) {
                    eventExists = true;
                    return; // Sortir de la boucle car un événement a été trouvé pour cette date
                }
            });

            // Si au moins un événement existe déjà pour l'une des dates sélectionnées, afficher un message
            if (eventExists) {
                alert("Vous ne pouvez pas ajouter plus d'un événement par jour.");
                return;
            }

            // Si aucun événement n'existe pour aucune des dates sélectionnées, permettre l'ajout d'événements
            var eventType = prompt("Veuillez sélectionner le type d'événement (congé payé, congé non payé, RTT) pour le(s) " + selectedDates.join(", "));
            if (eventType === null) {
                alert("Saisie annulée. L'événement ne sera pas créé pour le(s) " + selectedDates.join(", "));
                return;
              } else if (!["RTT", "congé payé", "congé non payé"].includes(eventType.trim())) {
                alert("Type d'événement invalide. Veuillez choisir parmi RTT, Congé payé ou Congé non payé.");
                return;
              }
            // Enregistrer l'événement pour chaque date sélectionnée
            selectedDates.forEach(function(date) {
                $.ajax({
                    type: "POST",
                    url: '/save_event/',
                    data: {
                        'type': eventType,
                        'start': date,
                        'end': date,
                    },
                    dataType: "json",
                    success: function (data) {
                        $('#calendar').fullCalendar('refetchEvents');
                        alert("Événement ajouté avec succès pour le " + date);
                    },
                    error: function (data) {
                        alert("Erreur lors de l'ajout de l'événement pour le " + date + ". Veuillez réessayer.");
                        console.error(data);
                    }
                });
            });
        },
        eventRender: function (event, element) {
            if (event.type) {
                const eventType = document.createElement('span');
                eventType.textContent = ` (${event.type})`;
                element.find('.fc-title').append(eventType);
            }
        },
        events: '/fetch_events/' // Assurez-vous que cette URL correspond à votre vue Django pour récupérer les événements
    });

    $('#events-btn').click(function () {
        var date = $("#calendar").fullCalendar('getDate');
        var month = date.month() + 1;
        var year = date.year();
        window.location.href = "{% url 'event_summary' %}";
    });
});

</script>
</body>
</html>
